{"version":3,"sources":["util/subTaskUtil.js"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;wBAIqB,UAAU;;;;oBACd,MAAM;;;;sBACJ,QAAQ;;;;sBACR,QAAQ;;;;wBACV,WAAW;;;;wBACX,WAAW;;;;;;;;;;;AAQrB,SAAS,yBAAyB,CAAC,IAAI,EAAE,SAAS,EAAE;;AAEzD,MAAM,KAAK,GAAG,CACZ,IAAI,GAAG,GAAG,GAAG,SAAS,GAAG,qBAAqB,EAC9C,IAAI,GAAG,KAAK,GAAG,SAAS,GAAG,qBAAqB,EAChD,IAAI,GAAG,OAAO,GAAG,SAAS,GAAG,qBAAqB,CACnD,CAAC;AACF,MAAM,WAAW,GAAG,oBAAO,IAAI,CAAC,KAAK,CAAC,CAAC;AACvC,MAAI,SAAS,GAAG,KAAK,CAAC;AACtB,MAAI,WAAW,CAAC,MAAM,GAAG,CAAC,EAAE;AAC1B,aAAS,GAAG,kBAAK,OAAO,CAAC,WAAW,CAAC,CAAC,CAAC,CAAC,CAAC;GAC1C;AACD,SAAO,SAAS,CAAC;CAClB;;;;;;;;AAQD,SAAS,WAAW,CAAC,IAAI,EAAE;AACzB,MAAM,IAAI,GAAG,2BAAS,OAAO,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC;AAC7C,MAAI,IAAI,CAAC,CAAC,CAAC,MAAM,GAAG,CAAC,EAAE;AACrB,QAAM,KAAK,GAAG,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC;AACpC,QAAI,KAAK,CAAC,MAAM,IAAI,CAAC,IAAI,KAAK,CAAC,CAAC,CAAC,KAAK,EAAE,EAAE;AACxC,UAAM,SAAS,GAAG,yBAAyB,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC;AAC5D,UAAI,SAAS,EAAE;AACb,eAAO;AACL,qBAAW,EAAE,KAAK,CAAC,CAAC,CAAC;AACrB,gBAAM,EAAE,KAAK,CAAC,CAAC,CAAC;AAChB,oBAAU,EAAE,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC;SAC7B,CAAC;OACH;KACF;GACF;AACD,SAAO,KAAK,CAAC;CACd;;;;;;;;;AAQM,SAAS,wBAAwB,CAAC,IAAI,EAAE;;AAE7C,MAAM,KAAK,GAAG,CACZ,IAAI,GAAG,uBAAuB,EAC9B,IAAI,GAAG,yBAAyB,EAChC,IAAI,GAAG,2BAA2B,CACnC,CAAC;AACF,MAAM,WAAW,GAAG,oBAAO,IAAI,CAAC,KAAK,CAAC,CAAC,GAAG,CAAC,UAAC,CAAC;WAAK,kBAAK,OAAO,CAAC,CAAC,CAAC;GAAA,CAAC,CAAC;AACnE,SAAO,WAAW,CAAC;CACpB;;;;;;;;;AAQM,SAAS,cAAc,CAAC,IAAI,EAAE,OAAO,EAAE;AAC5C,MAAM,IAAI,GAAG,EAAE,CAAC;AAChB,MAAI,IAAI,CAAC,OAAO,CAAC,EAAE;AACjB,QAAI,CAAC,IAAI,CAAC,IAAI,GAAG,OAAO,CAAC,CAAC;AAC1B,QAAI,OAAO,IAAI,CAAC,OAAO,CAAC,KAAK,SAAS,EAAE;AACtC,UAAI,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC,CAAC;KAC1B;GACF;AACD,SAAO,IAAI,CAAC;CACb;;;;;;;;AAOM,SAAS,mBAAmB,CAAC,OAAO,EAAE;AAC3C,MAAM,IAAI,GAAG,2BAAS,OAAO,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC;AAC7C,MAAI,OAAO,IAAI,OAAO,CAAC,IAAI,EAAE;AAC3B,6BAAO,IAAI,EAAE,IAAI,EAAE,OAAO,CAAC,IAAI,CAAC,CAAC;GAClC;AACD,MAAI,IAAI,CAAC,CAAC,EAAE;AACV,WAAO,IAAI,CAAC,CAAC,CAAC;GACf;AACD,MAAI,OAAO,GAAG,EAAE,CAAC;;AAEjB,SAAO,GAAG,OAAO,CAAC,MAAM,CAAC,cAAc,CAAC,IAAI,EAAE,MAAM,CAAC,CAAC,CAAC;AACvD,SAAO,GAAG,OAAO,CAAC,MAAM,CAAC,cAAc,CAAC,IAAI,EAAE,SAAS,CAAC,CAAC,CAAC;;AAE1D,SAAO,OAAO,CAAC;CAChB;;;;;;;;;;;AAUM,SAAS,WAAW,CAAC,IAAI,EAAE,OAAO,EAAE,EAAE,EAAE;AAC7C,MAAM,SAAS,GAAG,yBAAyB,CAAC,OAAO,CAAC,IAAI,EAAE,OAAO,CAAC,SAAS,CAAC,CAAC;AAC7E,MAAI,SAAS,EAAE;AACb,QAAI,CAAC,GAAG,CAAC,SAAS,GAAG,oBAAoB,EAAE,EAAC,MAAM,EAAE,KAAK,EAAC,CAAC,CACxD,IAAI,CAAC,2BAAK;AACT,aAAO,EAAE,CAAC,OAAO,CAAC,IAAI,CAAC;AACvB,YAAM,EAAE,mBAAmB,CAAC;AAC1B,cAAM,EAAE,OAAO,CAAC,IAAI,IAAI,EAAE;OAC3B,CAAC;KACH,CAAC,CAAC,CACF,EAAE,CAAC,KAAK,EAAE,EAAE,CAAC,CAAC;GAClB,MAAM;AACL,0BAAK,GAAG,CAAC,sBAAK,MAAM,CAAC,GAAG,iCAA+B,OAAO,CAAC,SAAS,OAAI,CAAC,CAAC;AAC9E,MAAE,EAAE,CAAC;GACN;CACF;;;;;;;;;;AASM,SAAS,0BAA0B,CAAC,IAAI,EAAE,OAAO,EAAE,EAAE,EAAE;AAC5D,MAAM,KAAK,GAAG,wBAAwB,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC,GAAG,CAAC,UAAC,GAAG;WAAK,GAAG,GAAG,oBAAoB;GAAA,CAAC,CAAC;AAC9F,MAAI,CAAC,GAAG,CAAC,KAAK,EAAE,EAAC,MAAM,EAAE,KAAK,EAAC,CAAC,CAC7B,IAAI,CAAC,2BAAK;AACT,WAAO,EAAE,CAAC,OAAO,CAAC,IAAI,CAAC;AACvB,UAAM,EAAE,mBAAmB,CAAC;AAC1B,YAAM,EAAE,OAAO,CAAC,IAAI,IAAI,EAAE;KAC3B,CAAC;GACH,CAAC,CAAC,CACF,EAAE,CAAC,KAAK,EAAE,EAAE,CAAC,CAAC;CAClB;;AAED,IAAM,WAAW,GAAG;AAClB,eAAa,EAAE,WAAW;AAC1B,6BAA2B,EAAE,yBAAyB;AACtD,4BAA0B,EAAE,wBAAwB;AACpD,uBAAqB,EAAE,mBAAmB;AAC1C,kBAAgB,EAAE,cAAc;AAChC,eAAa,EAAE,WAAW;AAC1B,8BAA4B,EAAE,0BAA0B;CACzD,CAAC;;qBAEa,WAAW","file":"util/subTaskUtil.js","sourcesContent":["/* This Source Code Form is subject to the terms of the Mozilla Public\r\n * License, v. 2.0. If a copy of the MPL was not distributed with this\r\n * file, You can obtain one at http://mozilla.org/MPL/2.0/. */\r\n\r\nimport minimist from 'minimist';\r\nimport path from 'path';\r\nimport globby from 'globby';\r\nimport extend from 'extend';\r\nimport util from 'gulp-util';\r\nimport chug from 'gulp-chug';\r\n\r\n/**\r\n * Resolve a Component Directory from the Root directory\r\n *\r\n * It will find the component directory containing \"cu-build.config.js\"\r\n * It will only look into 3 directory levels, this should be enough depth for component nesting.\r\n */\r\nexport function resolveComponentDirectory(root, component) {\r\n  // search for the component containing a cu-build.config.js\r\n  const globs = [\r\n    root + '/' + component + '/cu-build.config.js',\r\n    root + '/*/' + component + '/cu-build.config.js',\r\n    root + '/*/*/' + component + '/cu-build.config.js',\r\n  ];\r\n  const directories = globby.sync(globs);\r\n  let directory = false;\r\n  if (directories.length > 0) {\r\n    directory = path.dirname(directories[0]);\r\n  }\r\n  return directory;\r\n}\r\n\r\n/**\r\n * Resolve a Sub Task based on process arguments\r\n * It should match tasks as \"component::task\"\r\n * It will check that a \"cu-build.config.json\" exists in the target component directory\r\n * Example: component-one::build -> would execute build on component-one\r\n */\r\nfunction resolveTask(root) {\r\n  const argv = minimist(process.argv.slice(2));\r\n  if (argv._.length > 0) {\r\n    const parts = argv._[0].split('::');\r\n    if (parts.length >= 2 && parts[1] !== '') {\r\n      const directory = resolveComponentDirectory(root, parts[0]);\r\n      if (directory) {\r\n        return {\r\n          'component': parts[0],\r\n          'task': parts[1],\r\n          'gulpTask': parts.join('::'),\r\n        };\r\n      }\r\n    }\r\n  }\r\n  return false;\r\n}\r\n\r\n/**\r\n * Resolve all Component Directories from the Root directory\r\n *\r\n * It will find all component directories containing \"cu-build.config.js\"\r\n * It will only look into 3 directory levels, this should be enough depth for component nesting.\r\n */\r\nexport function findComponentDirectories(root) {\r\n  // search for all components containing a cu-build.config.js\r\n  const globs = [\r\n    root + '/*/cu-build.config.js',\r\n    root + '/*/*/cu-build.config.js',\r\n    root + '/*/*/*/cu-build.config.js',\r\n  ];\r\n  const directories = globby.sync(globs).map((p) => path.dirname(p));\r\n  return directories;\r\n}\r\n\r\n/**\r\n * Create a chug argument\r\n *\r\n * This will convert an object argument into a switch for chug\r\n * Example: {path: 'here'} will become ['--path', 'here']\r\n */\r\nexport function createArgument(argv, argName) {\r\n  const args = [];\r\n  if (argv[argName]) {\r\n    args.push('--' + argName);\r\n    if (typeof argv[argName] !== 'boolean') {\r\n      args.push(argv[argName]);\r\n    }\r\n  }\r\n  return args;\r\n}\r\n\r\n/**\r\n * Get arguments to pass to chug\r\n *\r\n * This will build a set of arguments ready to be passed to chug\r\n */\r\nexport function getSubTaskArguments(options) {\r\n  const argv = minimist(process.argv.slice(2));\r\n  if (options && options.args) {\r\n    extend(true, argv, options.args);\r\n  }\r\n  if (argv._) {\r\n    delete argv._;\r\n  }\r\n  let subArgs = [];\r\n\r\n  subArgs = subArgs.concat(createArgument(argv, 'port'));\r\n  subArgs = subArgs.concat(createArgument(argv, 'publish'));\r\n\r\n  return subArgs;\r\n}\r\n\r\n/**\r\n * Execute a Sub Task on specific component\r\n * Options:\r\n *    path: the root path\r\n *    component: the component to execute task on\r\n *    task: the task to execute\r\n *    args: the override arguments to pass to chug\r\n */\r\nexport function executeTask(gulp, options, cb) {\r\n  const directory = resolveComponentDirectory(options.path, options.component);\r\n  if (directory) {\r\n    gulp.src(directory + '/gulpfile.babel.js', {'read': false})\r\n      .pipe(chug({\r\n        'tasks': [options.task],\r\n        'args': getSubTaskArguments({\r\n          'args': options.args || {},\r\n        }),\r\n      }))\r\n      .on('end', cb);\r\n  } else {\r\n    util.log(util.colors.red(`Could not find Component: \"${options.component}\"`));\r\n    cb();\r\n  }\r\n}\r\n\r\n/**\r\n * Execute a Sub Task on all components\r\n * Options:\r\n *    path: the root path\r\n *    task: the task to execute\r\n *    args: the override arguments to pass to chug\r\n */\r\nexport function executeTaskOnAllComponents(gulp, options, cb) {\r\n  const gulps = findComponentDirectories(options.path).map((dir) => dir + '/gulpfile.babel.js');\r\n  gulp.src(gulps, {'read': false})\r\n    .pipe(chug({\r\n      'tasks': [options.task],\r\n      'args': getSubTaskArguments({\r\n        'args': options.args || {},\r\n      }),\r\n    }))\r\n    .on('end', cb);\r\n}\r\n\r\nconst subTaskUtil = {\r\n  'resolveTask': resolveTask,\r\n  'resolveComponentDirectory': resolveComponentDirectory,\r\n  'findComponentDirectories': findComponentDirectories,\r\n  'getSubTaskArguments': getSubTaskArguments,\r\n  'createArgument': createArgument,\r\n  'executeTask': executeTask,\r\n  'executeTaskOnAllComponents': executeTaskOnAllComponents,\r\n};\r\n\r\nexport default subTaskUtil;\r\n"],"sourceRoot":"/source/"}